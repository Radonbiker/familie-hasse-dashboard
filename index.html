<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Familie Hasse ‚Äì Essensplan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#1a100b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --wood-dark: #1a100b;
      --wood: #25170f;
      --wood-light: #3d2518;
      --accent: #e0a15b;
      --accent-soft: #f3c48a;
      --text: #f6e7d5;
      --text-soft: #c8a88a;
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, var(--wood-light), var(--wood-dark));
      color: var(--text);
      overflow-x: hidden;
    }
    header {
      background: linear-gradient(135deg, #4d2e1c, #1d120c);
      color: var(--text);
      padding: 12px 18px;
      font-size: 1.4rem;
      font-weight: 600;
      display:flex;
      align-items:center;
      gap:10px;
      position:sticky;
      top:0;
      z-index:10;
      box-shadow:0 4px 18px rgba(0,0,0,0.4);
    }
    header small {
      font-size:0.8rem;
      color:var(--text-soft);
      font-weight:400;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 12px 20px;
      display:grid;
      grid-template-columns: 0.9fr 1.4fr;
      gap:12px;
    }
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: rgba(0,0,0,0.35);
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 6px 18px rgba(0,0,0,0.4);
    }
    .panel h2 {
      margin: 0 0 6px;
      font-size: 1.05rem;
      color: var(--accent-soft);
    }
    small { color: var(--text-soft); }

    /* Lieblingsbubbles */
    .fav-grid {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:6px;
      margin-bottom:8px;
    }
    .fav-bubble {
      background: rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 6px 4px;
      text-align:center;
      font-size:0.78rem;
      cursor:grab;
      user-select:none;
      border:1px solid rgba(255,255,255,0.18);
    }
    .fav-bubble span {
      display:block;
      font-size:1.2rem;
      margin-bottom:3px;
    }
    .fav-bubble:active {
      transform:scale(0.96);
      opacity:0.9;
    }

    /* Kategorien */
    .category {
      background: rgba(0,0,0,0.22);
      border-radius: 10px;
      margin-bottom: 6px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
    }
    .category-header {
      padding:6px 8px;
      font-size:0.9rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      background:rgba(255,255,255,0.06);
    }
    .category-content {
      display:none;
      padding:6px;
    }
    .category-content.open { display:block; }
    .cat-item {
      padding:4px 6px;
      border-radius:8px;
      font-size:0.84rem;
      background:rgba(255,255,255,0.06);
      cursor:grab;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .cat-item span.emoji { font-size:1.1rem; }

    /* Gerichte-Liste */
    .meal-list {
      display:flex;
      flex-direction:column;
      gap:5px;
      max-height:220px;
      overflow-y:auto;
      margin-top:6px;
      padding-right:3px;
    }
    .meal-card {
      display:flex;
      align-items:center;
      background:rgba(255,255,255,0.08);
      padding:5px 8px;
      border-radius:9px;
      cursor:grab;
      user-select:none;
      border:1px solid rgba(255,255,255,0.08);
      font-size:0.86rem;
    }
    .meal-card span.emoji {
      font-size:1.1rem;
      margin-right:6px;
    }
    .meal-card span.name {
      flex:1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meal-card .delete {
      font-size:1.05rem;
      cursor:pointer;
      margin-left:8px;
      opacity:0.8;
    }
    .meal-card .delete:hover { opacity:1; }

    .meal-form {
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:5px;
    }
    .meal-form input {
      padding:6px 8px;
      border-radius:9px;
      border:none;
      background:rgba(0,0,0,0.55);
      color:var(--text);
      font-size:0.86rem;
    }
    .meal-form button {
      padding:7px 8px;
      border-radius:9px;
      border:none;
      background:var(--accent);
      color:#2a150a;
      font-weight:600;
      font-size:0.9rem;
      cursor:pointer;
    }

    /* Wochenplan */
    .week-grid {
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    @media (max-width: 1100px) {
      .week-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    .day-col {
      background:rgba(255,255,255,0.05);
      padding:5px;
      border-radius:10px;
      font-size:0.8rem;
    }
    .day-title {
      font-weight:600;
      margin-bottom:3px;
      text-align:center;
    }
    .slot {
      background:rgba(0,0,0,0.25);
      padding:5px;
      margin-top:4px;
      border-radius:8px;
      border:1px dashed rgba(255,255,255,0.15);
      min-height:54px;
    }
    .slot-label {
      font-size:0.72rem;
      color:var(--text-soft);
      text-transform:uppercase;
      letter-spacing:0.06em;
    }
    .slot-content {
      margin-top:2px;
      font-size:0.86rem;
      font-weight:600;
      min-height:1.2em;
    }
    .slot.empty .slot-content {
      font-size:0.78rem;
      color:#9c7a54;
    }
    .slot.drag-over {
      background:rgba(250,210,140,0.16);
      border-color:var(--accent-soft);
    }

    footer {
      text-align:center;
      font-size:0.75rem;
      color:var(--text-soft);
      padding:6px 0 12px;
    }
  </style>
</head>
<body>
  <header>
    <span>üçΩÔ∏è</span>
    <div>
      Familie Hasse ‚Äì Essensplan<br/>
      <small>Lieblingsessen, Kategorien & Wochenplan ‚Äì optimiert f√ºrs Wand‚ÄëiPad</small>
    </div>
  </header>

  <div class="container">
    <div class="panel">
      <h2>Lieblingsessen</h2>
      <small>Antippen f√ºr ‚ÄûTap‚ÄëDrop‚Äú oder ziehen zum Planen. Reihenfolge oben = Reihenfolge hier.</small>
      <div id="fav-grid" class="fav-grid"></div>

      <h2 style="margin-top:10px;">Kategorien</h2>
      <div id="categories"></div>

      <h2 style="margin-top:10px;">Alle Gerichte</h2>
      <small>Hier kannst du Gerichte hinzuf√ºgen, sortieren oder l√∂schen.</small>
      <div id="meal-list" class="meal-list"></div>

      <form id="meal-form" class="meal-form">
        <input id="meal-name" placeholder="Gericht (z.‚ÄØB. Spinat mit Kartoffeln)" required />
        <input id="meal-emoji" placeholder="Emoji (optional, z.‚ÄØB. üçù)" />
        <button type="submit">‚ûï Gericht hinzuf√ºgen</button>
      </form>
    </div>

    <div class="panel">
      <h2>Wochenplan</h2>
      <small>Mittag & Abend ‚Äì Drag & Drop oder Tap‚ÄëDrop. Tippen auf einen Slot leert ihn.</small>
      <div id="week-grid" class="week-grid"></div>
    </div>
  </div>

  <footer>
    Alles wird lokal im Browser gespeichert. Als App vom Home‚ÄëBildschirm starten = perfekte Wandsteuerung. ‚ù§Ô∏è
  </footer>

  <script>
    const STORAGE_KEY = "familie_hasse_essenplan_pwa_v1";

    const defaultMeals = [
      {id:"spagbol", name:"Spaghetti Bolognese", emoji:"üçù"},
      {id:"gulasch", name:"Gulasch", emoji:"üç≤"},
      {id:"rouladen", name:"Rouladen mit Kl√∂√üen", emoji:"ü•©"},
      {id:"pizza", name:"Pizza", emoji:"üçï"},
      {id:"klopse", name:"K√∂nigsberger Klopse", emoji:"üçñ"},
      {id:"schnipom", name:"Schnitzel mit Pommes", emoji:"üçü"},
      {id:"bowl", name:"Bowl", emoji:"ü•ó"},
      {id:"geschnetzeltes", name:"Geschnetzeltes", emoji:"üçõ"},
    ];

    const defaultFavorites = ["spagbol","gulasch","rouladen","pizza","klopse","schnipom","bowl","geschnetzeltes"];

    const defaultCategories = {
      "üçù Nudeln": [
        {id:"nudeln-tomate", name:"Nudeln mit Tomatensauce", emoji:"üçù"},
        {id:"mac-cheese", name:"Mac & Cheese", emoji:"üßÄ"},
        {id:"nudelsuppe", name:"Nudelsuppe", emoji:"üçú"},
      ],
      "ü•© Fleisch": [
        {id:"gyros", name:"Gyros", emoji:"ü•©"},
        {id:"frikadellen", name:"Frikadellen", emoji:"üçñ"},
      ],
      "ü•ó Leicht & Bowl": [
        {id:"gemuesepfanne", name:"Gem√ºsepfanne", emoji:"ü•¶"},
        {id:"reis-bowl", name:"Reis-Bowl", emoji:"ü•ó"},
      ],
      "üçï Schnell": [
        {id:"hotdog", name:"Hotdog", emoji:"üå≠"},
        {id:"sandwich", name:"Sandwich", emoji:"ü•™"},
        {id:"roesti", name:"Kartoffelr√∂sti", emoji:"ü•î"},
      ],
      "üç≤ Suppe & Eintopf": [
        {id:"kartoffelsuppe", name:"Kartoffelsuppe", emoji:"ü•£"},
        {id:"tomatensuppe", name:"Tomatensuppe", emoji:"üçÖ"},
        {id:"chili", name:"Chili", emoji:"üå∂Ô∏è"},
      ]
    };

    const dayNames = ["Mo","Di","Mi","Do","Fr","Sa","So"];

    function createEmptyWeek() {
      const week = [];
      for (let i = 0; i < 7; i++) {
        week.push({ lunch: null, dinner: null });
      }
      return week;
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          return {
            meals: [...defaultMeals],
            favorites: [...defaultFavorites],
            categories: defaultCategories,
            week: createEmptyWeek(),
          };
        }
        const parsed = JSON.parse(raw);
        if (!parsed.meals) parsed.meals = [...defaultMeals];
        if (!parsed.favorites) parsed.favorites = [...defaultFavorites];
        if (!parsed.categories) parsed.categories = defaultCategories;
        if (!parsed.week) parsed.week = createEmptyWeek();
        return parsed;
      } catch (e) {
        console.error("Fehler beim Laden, setze zur√ºck:", e);
        return {
          meals: [...defaultMeals],
          favorites: [...defaultFavorites],
          categories: defaultCategories,
          week: createEmptyWeek(),
        };
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Speichern fehlgeschlagen:", e);
      }
    }

    let state = loadState();
    let activeTapMealId = null;

    const favGridEl = document.getElementById("fav-grid");
    const categoriesEl = document.getElementById("categories");
    const mealListEl = document.getElementById("meal-list");
    const weekGridEl = document.getElementById("week-grid");

    function getMealById(id) {
      return state.meals.find(m => m.id === id) || null;
    }

    function renderFavorites() {
      favGridEl.innerHTML = "";
      state.favorites.forEach(id => {
        const meal = getMealById(id);
        if (!meal) return;
        const div = document.createElement("div");
        div.className = "fav-bubble";
        div.draggable = true;
        div.innerHTML = `<span>${meal.emoji || "üçΩÔ∏è"}</span>${meal.name}`;
        div.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", meal.id);
          e.dataTransfer.effectAllowed = "copyMove";
        });
        div.addEventListener("click", () => {
          activeTapMealId = meal.id;
        });
        favGridEl.appendChild(div);
      });
    }

    function renderCategories() {
      categoriesEl.innerHTML = "";
      Object.entries(state.categories).forEach(([catTitle, items]) => {
        const wrap = document.createElement("div");
        wrap.className = "category";
        const head = document.createElement("div");
        head.className = "category-header";
        head.innerHTML = `<span>${catTitle}</span><span>‚ñº</span>`;
        const content = document.createElement("div");
        content.className = "category-content";
        items.forEach(meal => {
          const item = document.createElement("div");
          item.className = "cat-item";
          item.draggable = true;
          item.innerHTML = `<span class="emoji">${meal.emoji || "üçΩÔ∏è"}</span><span>${meal.name}</span>`;
          item.addEventListener("dragstart", e => {
            e.dataTransfer.setData("text/plain", meal.id);
            e.dataTransfer.effectAllowed = "copyMove";
          });
          item.addEventListener("click", () => {
            activeTapMealId = meal.id;
          });
          content.appendChild(item);
        });
        head.addEventListener("click", () => {
          content.classList.toggle("open");
        });
        wrap.appendChild(head);
        wrap.appendChild(content);
        categoriesEl.appendChild(wrap);
      });
    }

    let dragMealId = null;
    let dragOverMealId = null;

    function renderMealList() {
      mealListEl.innerHTML = "";
      state.meals.forEach(meal => {
        const card = document.createElement("div");
        card.className = "meal-card";
        card.draggable = true;
        card.dataset.id = meal.id;
        card.innerHTML = `
          <span class="emoji">${meal.emoji || "üçΩÔ∏è"}</span>
          <span class="name">${meal.name}</span>
          <span class="delete">üóëÔ∏è</span>
        `;

        card.addEventListener("dragstart", e => {
          dragMealId = meal.id;
          e.dataTransfer.setData("text/plain", meal.id);
          e.dataTransfer.effectAllowed = "move";
        });

        card.addEventListener("dragover", e => {
          e.preventDefault();
          e.stopPropagation();
          dragOverMealId = meal.id;
        });

        card.addEventListener("drop", e => {
          e.preventDefault();
          e.stopPropagation();
          if (!dragMealId || dragMealId === meal.id) return;
          const fromIndex = state.meals.findIndex(m => m.id === dragMealId);
          const toIndex = state.meals.findIndex(m => m.id === meal.id);
          if (fromIndex === -1 || toIndex === -1) return;
          const [moved] = state.meals.splice(fromIndex, 1);
          state.meals.splice(toIndex, 0, moved);
          state.favorites = state.favorites.filter(id => state.meals.some(m => m.id === id));
          saveState();
          renderAll();
          dragMealId = null;
          dragOverMealId = null;
        });

        card.addEventListener("click", () => {
          activeTapMealId = meal.id;
        });

        card.querySelector(".delete").addEventListener("click", e => {
          e.stopPropagation();
          if (!confirm(`"${meal.name}" wirklich l√∂schen?`)) return;
          state.meals = state.meals.filter(m => m.id !== meal.id);
          state.favorites = state.favorites.filter(id => id !== meal.id);
          state.week.forEach(day => {
            if (day.lunch === meal.id) day.lunch = null;
            if (day.dinner === meal.id) day.dinner = null;
          });
          saveState();
          renderAll();
        });

        mealListEl.appendChild(card);
      });
    }

    function renderWeek() {
      weekGridEl.innerHTML = "";
      state.week.forEach((day, index) => {
        const col = document.createElement("div");
        col.className = "day-col";
        const title = document.createElement("div");
        title.className = "day-title";
        title.textContent = dayNames[index];
        col.appendChild(title);
        ["lunch","dinner"].forEach(slotKey => {
          const slotEl = document.createElement("div");
          slotEl.className = "slot";
          slotEl.dataset.day = index;
          slotEl.dataset.slot = slotKey;
          const label = document.createElement("div");
          label.className = "slot-label";
          label.textContent = slotKey === "lunch" ? "Mittag" : "Abend";
          const content = document.createElement("div");
          content.className = "slot-content";
          const mealId = day[slotKey];
          if (mealId) {
            const meal = getMealById(mealId);
            if (meal) {
              content.textContent = `${meal.emoji || "üçΩÔ∏è"} ${meal.name}`;
            } else {
              content.textContent = "(Gericht nicht mehr vorhanden)";
            }
          } else {
            content.textContent = "Gericht hierher ziehen oder ausw√§hlen";
            slotEl.classList.add("empty");
          }
          slotEl.appendChild(label);
          slotEl.appendChild(content);

          slotEl.addEventListener("dragover", e => {
            e.preventDefault();
            e.stopPropagation();
            slotEl.classList.add("drag-over");
          });
          slotEl.addEventListener("dragleave", e => {
            e.preventDefault();
            e.stopPropagation();
            slotEl.classList.remove("drag-over");
          });
          slotEl.addEventListener("drop", e => {
            e.preventDefault();
            e.stopPropagation();
            slotEl.classList.remove("drag-over");
            const mealIdDrop = e.dataTransfer.getData("text/plain");
            if (!mealIdDrop) return;
            const meal = getMealById(mealIdDrop);
            if (!meal) return;
            const d = parseInt(slotEl.dataset.day, 10);
            const key = slotEl.dataset.slot;
            state.week[d][key] = meal.id;
            saveState();
            renderWeek();
          });

          slotEl.addEventListener("click", () => {
            const d = parseInt(slotEl.dataset.day, 10);
            const key = slotEl.dataset.slot;
            if (activeTapMealId) {
              const meal = getMealById(activeTapMealId);
              if (!meal) return;
              state.week[d][key] = meal.id;
              activeTapMealId = null;
              saveState();
              renderWeek();
            } else if (state.week[d][key]) {
              if (confirm("Eintrag l√∂schen?")) {
                state.week[d][key] = null;
                saveState();
                renderWeek();
              }
            }
          });

          col.appendChild(slotEl);
        });
        weekGridEl.appendChild(col);
      });
    }

    const formEl = document.getElementById("meal-form");
    formEl.addEventListener("submit", e => {
      e.preventDefault();
      const nameInput = document.getElementById("meal-name");
      const emojiInput = document.getElementById("meal-emoji");
      const name = nameInput.value.trim();
      const emoji = emojiInput.value.trim() || "üçΩÔ∏è";
      if (!name) return;
      const idBase = name.toLowerCase().replace(/[^a-z0-9]+/g, "-");
      let id = idBase || ("meal-" + Date.now());
      let i = 1;
      while (state.meals.some(m => m.id === id)) {
        id = idBase + "-" + i++;
      }
      state.meals.push({ id, name, emoji });
      saveState();
      nameInput.value = "";
      emojiInput.value = "";
      renderAll();
    });

    function renderAll() {
      renderFavorites();
      renderCategories();
      renderMealList();
      renderWeek();
    }

    renderAll();

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js").catch(err => {
          console.warn("Service Worker Registrierung fehlgeschlagen:", err);
        });
      });
    }
  </script>
</body>
</html>
